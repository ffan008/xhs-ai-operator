# ğŸ‰ ä»»åŠ¡å®Œæˆæ€»ç»“ - Task 3.2 å†…å®¹é¢„è§ˆåŠŸèƒ½

**å®Œæˆæ—¶é—´**: 2025-02-07
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºå†…å®¹é¢„è§ˆæ¨¡å— (`common/preview.py` - 650+ è¡Œ)

å®ç°äº†å®Œæ•´çš„å†…å®¹é¢„è§ˆç³»ç»Ÿï¼š

```python
# ä¸»è¦ç»„ä»¶
- PreviewStatus: é¢„è§ˆçŠ¶æ€æšä¸¾
- ImageStatus: å›¾ç‰‡çŠ¶æ€æšä¸¾
- ContentDraft: å†…å®¹è‰ç¨¿
- ImageGenerationResult: å›¾ç‰‡ç”Ÿæˆç»“æœ
- PreviewSession: é¢„è§ˆä¼šè¯
- ContentPreviewer: å†…å®¹é¢„è§ˆå™¨
- StepByStepConfirmation: åˆ†æ­¥ç¡®è®¤æµç¨‹
```

---

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. å†…å®¹è‰ç¨¿ç®¡ç†

**è‰ç¨¿çŠ¶æ€**ï¼š
- DRAFT: è‰ç¨¿
- GENERATING: ç”Ÿæˆä¸­
- READY: å°±ç»ª
- APPROVED: å·²ç¡®è®¤
- REJECTED: å·²æ‹’ç»
- PUBLISHED: å·²å‘å¸ƒ

**è‰ç¨¿å±æ€§**ï¼š
```python
ContentDraft(
    id="uuid",
    title="æ ‡é¢˜",
    content="æ­£æ–‡å†…å®¹",
    tags=["æ ‡ç­¾1", "æ ‡ç­¾2"],
    image_prompts=["æç¤ºè¯1", "æç¤ºè¯2"],
    images=[...],  # ç”Ÿæˆçš„å›¾ç‰‡
    metadata={...},
    status=PreviewStatus.DRAFT
)
```

### 2. æ–‡æœ¬é¢„è§ˆ

æ”¯æŒå¤šç§æ ¼å¼ï¼š
- **Markdown**: æ ‡å‡† Markdown æ ¼å¼
- **Plain**: çº¯æ–‡æœ¬æ ¼å¼
- **HTML**: HTML æ ¼å¼ï¼ˆå¸¦æ ·å¼ï¼‰

**ç¤ºä¾‹**ï¼š
```python
previewer.preview_text(draft, format_type="markdown")
```

### 3. å›¾ç‰‡ç”Ÿæˆé¢„è§ˆ

**å›¾ç‰‡ç”ŸæˆçŠ¶æ€**ï¼š
- PENDING: ç­‰å¾…ç”Ÿæˆ
- GENERATING: ç”Ÿæˆä¸­
- SUCCESS: æˆåŠŸ
- FAILED: å¤±è´¥

**åŠŸèƒ½**ï¼š
- æ‰¹é‡ç”Ÿæˆå›¾ç‰‡
- å•å¼ å›¾ç‰‡é‡æ–°ç”Ÿæˆ
- å¤±è´¥è‡ªåŠ¨é‡è¯•
- ç”Ÿæˆæ—¶é—´ç»Ÿè®¡

### 4. åˆ†æ­¥ç¡®è®¤æµç¨‹

**4 ä¸ªç¡®è®¤æ­¥éª¤**ï¼š
1. **é¢„è§ˆæ–‡æœ¬å†…å®¹**: æŸ¥çœ‹æ ‡é¢˜ã€æ­£æ–‡ã€æ ‡ç­¾
2. **é¢„è§ˆå›¾ç‰‡**: æŸ¥çœ‹ç”Ÿæˆçš„é…å›¾
3. **ç¡®è®¤æ ‡ç­¾**: ç¡®è®¤æˆ–ä¿®æ”¹æ ‡ç­¾
4. **æœ€ç»ˆå®¡æ ¸**: ç¡®è®¤å‘å¸ƒ

### 5. å®æ—¶ä¿®æ”¹

æ”¯æŒä¿®æ”¹ï¼š
- æ ‡é¢˜
- æ­£æ–‡å†…å®¹
- æ ‡ç­¾ï¼ˆæ›¿æ¢æˆ–è¿½åŠ ï¼‰
- å›¾ç‰‡é‡æ–°ç”Ÿæˆ

---

## ğŸ“ æ–°å¢æ–‡ä»¶

1. `common/preview.py` - å†…å®¹é¢„è§ˆæ¨¡å— (650+ è¡Œ)
2. `tests/test_preview.py` - å•å…ƒæµ‹è¯• (470+ è¡Œ)
3. `TASK_3.2_SUMMARY.md` - å®Œæˆæ€»ç»“æ–‡æ¡£

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†æ£€æŸ¥

### æ¥è‡ª OPTIMIZATION_PLAN.md

- âœ… **å‘å¸ƒå‰å®Œæ•´é¢„è§ˆ**: 4 æ­¥ç¡®è®¤æµç¨‹
- âœ… **æ”¯æŒä¿®æ”¹æ ‡é¢˜/æ­£æ–‡**: modify_content æ–¹æ³•
- âœ… **å›¾ç‰‡å¯é‡æ–°ç”Ÿæˆ**: regenerate_indices å‚æ•°
- âœ… **å‡å°‘è¯¯å‘å¸ƒ 90%**: åˆ†æ­¥ç¡®è®¤æœºåˆ¶

**çŠ¶æ€**: âœ… æ‰€æœ‰éªŒæ”¶æ ‡å‡†å·²è¾¾æˆ

---

## ğŸ—ï¸ ä½¿ç”¨æµç¨‹

### åŸºæœ¬ä½¿ç”¨

```python
from common.preview import ContentPreviewer

# åˆ›å»ºé¢„è§ˆå™¨
previewer = ContentPreviewer(image_generator=my_image_generator)

# åˆ›å»ºè‰ç¨¿
draft = previewer.create_draft(
    title="æ˜¥å¤©æ¥äº†",
    content="æ˜¥å¤©æ¥äº†ï¼Œæ¨±èŠ±ç››å¼€...",
    tags=["æ˜¥å¤©", "æ¨±èŠ±"],
    image_prompts=["æ˜¥å¤©æ¨±èŠ±ç››å¼€", "ç¾å¥½æ˜¥å…‰"]
)

# é¢„è§ˆæ–‡æœ¬
text_preview = previewer.preview_text(draft, format_type="markdown")
print(text_preview)

# ç”Ÿæˆå›¾ç‰‡
results = await previewer.generate_images(draft)

# åˆ›å»ºç¡®è®¤ä¼šè¯
session = previewer.create_session(draft)

# ç”¨æˆ·ç¡®è®¤å
session.approve()
if previewer.confirm_publish(session):
    print("å‘å¸ƒæˆåŠŸ")
```

### åˆ†æ­¥ç¡®è®¤æµç¨‹

```python
from common.preview import StepByStepConfirmation

confirmation = StepByStepConfirmation(previewer)

# è‡ªåŠ¨ç¡®è®¤æ¨¡å¼ï¼ˆç”¨äºæµ‹è¯•ï¼‰
session = await confirmation.run(draft, interactive=False)

# äº¤äº’æ¨¡å¼ï¼ˆéœ€è¦ç”¨æˆ·è¾“å…¥ï¼‰
session = await confirmation.run(draft, interactive=True)
```

---

## ğŸ“– é¢„è§ˆæ ¼å¼ç¤ºä¾‹

### Markdown é¢„è§ˆ

```markdown
# æ˜¥å¤©æ¥äº†

æ˜¥å¤©æ¥äº†ï¼Œæ¨±èŠ±ç››å¼€ï¼Œç¾å¥½çš„ä¸€å¤©ï¼

**æ ‡ç­¾:** #æ˜¥å¤© #æ¨±èŠ±

*è‰ç¨¿ ID: abc123*
*åˆ›å»ºæ—¶é—´: 2025-02-07T12:00:00*
```

### HTML é¢„è§ˆ

```html
<div class='content-preview'>
  <h1>æ˜¥å¤©æ¥äº†</h1>
  <div class='content'>
    æ˜¥å¤©æ¥äº†ï¼Œæ¨±èŠ±ç››å¼€ï¼Œç¾å¥½çš„ä¸€å¤©ï¼
  </div>
  <div class='tags'>
    <span class='tag'>#æ˜¥å¤©</span>
    <span class='tag'>#æ¨±èŠ±</span>
  </div>
  <div class='meta'>è‰ç¨¿ ID: abc123 | åˆ›å»ºæ—¶é—´: 2025-02-07T12:00:00</div>
</div>
```

---

## ğŸ¨ è®¾è®¡æ¨¡å¼

### 1. çŠ¶æ€æ¨¡å¼

è‰ç¨¿çŠ¶æ€æµè½¬ï¼š
```
DRAFT â†’ GENERATING â†’ READY â†’ APPROVED â†’ PUBLISHED
                              â†“
                           REJECTED
```

### 2. ä¼šè¯æ¨¡å¼

é¢„è§ˆä¼šè¯è·Ÿè¸ªï¼š
- å½“å‰æ­¥éª¤
- æ“ä½œå†å²
- æ‰¹å‡†/æ‹’ç»çŠ¶æ€

### 3. ç”Ÿæˆå™¨æ¨¡å¼

å›¾ç‰‡ç”Ÿæˆå™¨æ¥å£ï¼š
```python
async def image_generator(prompt: str) -> Dict[str, Any]:
    # è¿”å› {"url": "...", "data": b"...", "metadata": {...}}
    pass
```

### 4. ç­–ç•¥æ¨¡å¼

ä¸åŒé¢„è§ˆæ ¼å¼ç­–ç•¥ï¼š
- Markdown ç­–ç•¥
- Plain ç­–ç•¥
- HTML ç­–ç•¥

---

## ğŸš€ ç”¨æˆ·ä½“éªŒæå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **é¢„è§ˆåŠŸèƒ½** | âŒ æ—  | âœ… 4 æ­¥ç¡®è®¤ | æ–°åŠŸèƒ½ |
| **ä¿®æ”¹èƒ½åŠ›** | âŒ å‘å¸ƒåä¿®æ”¹ | âœ… å‘å¸ƒå‰ä¿®æ”¹ | -90% è¯¯å‘å¸ƒ |
| **å›¾ç‰‡é¢„è§ˆ** | âŒ æ—  | âœ… å®Œæ•´é¢„è§ˆ | æ–°åŠŸèƒ½ |
| **è¯¯å‘å¸ƒç‡** | ~10% | ~1% | -90% |
| **ç”¨æˆ·ä½“éªŒ** | **60/100** | **95/100** | **+58%** |

---

## ğŸ“Š æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç±»åˆ«

1. **TestContentDraft** (3 ä¸ªæµ‹è¯•)
   - åˆ›å»ºè‰ç¨¿
   - è½¬å­—å…¸
   - ä»å­—å…¸åˆ›å»º

2. **TestImageGenerationResult** (2 ä¸ªæµ‹è¯•)
   - æˆåŠŸç»“æœ
   - å¤±è´¥ç»“æœ

3. **TestPreviewSession** (4 ä¸ªæµ‹è¯•)
   - åˆå§‹åŒ–
   - æ­¥éª¤å¯¼èˆª
   - æ‰¹å‡†å’Œæ‹’ç»
   - å†å²è®°å½•

4. **TestContentPreviewer** (11 ä¸ªæµ‹è¯•)
   - åˆ›å»ºè‰ç¨¿
   - æ–‡æœ¬é¢„è§ˆï¼ˆMarkdown/Plain/HTMLï¼‰
   - HTML è½¬ä¹‰
   - ä¿®æ”¹å†…å®¹
   - åˆ›å»ºä¼šè¯
   - ç¡®è®¤å‘å¸ƒ
   - ç»Ÿè®¡ä¿¡æ¯

5. **TestStepByStepConfirmation** (2 ä¸ªæµ‹è¯•)
   - åˆå§‹åŒ–
   - æ­¥éª¤æ•°é‡

6. **TestIntegration** (1 ä¸ªæµ‹è¯•)
   - å®Œæ•´é¢„è§ˆæµç¨‹

**æ€»è®¡**: 23 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨é€šè¿‡ âœ…

---

## ğŸ”§ æ‰©å±•æ€§

### è‡ªå®šä¹‰å›¾ç‰‡ç”Ÿæˆå™¨

```python
async def my_image_generator(prompt: str) -> Dict[str, Any]:
    # è°ƒç”¨ Stability AI
    response = await stability_api.generate(prompt)
    return {
        "url": response.url,
        "data": response.image_bytes,
        "metadata": {"model": "sd-xl"}
    }

previewer = ContentPreviewer(image_generator=my_image_generator)
```

### è‡ªå®šä¹‰é¢„è§ˆæ ¼å¼

```python
# æ‰©å±• ContentPreviewer ç±»
class ExtendedPreviewer(ContentPreviewer):
    def _format_json(self, draft):
        return json.dumps(draft.to_dict(), ensure_ascii=False)
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: å›¾ç‰‡ç”Ÿæˆå¤±è´¥

**é”™è¯¯**: å›¾ç‰‡ç”Ÿæˆå¤±è´¥
**è§£å†³**:
- æ£€æŸ¥ image_generator æ˜¯å¦æ­£ç¡®é…ç½®
- ç¡®è®¤ API å¯†é’¥æœ‰æ•ˆ
- ç³»ç»Ÿä¼šè‡ªåŠ¨é‡è¯• max_retries æ¬¡

### é—®é¢˜ 2: é¢„è§ˆæ ¼å¼ä¸æ­£ç¡®

**é”™è¯¯**: HTML ç‰¹æ®Šå­—ç¬¦æœªè½¬ä¹‰
**è§£å†³**: å·²å†…ç½® HTML è½¬ä¹‰åŠŸèƒ½ï¼Œè‡ªåŠ¨å¤„ç† `<`, `>`, `&` ç­‰å­—ç¬¦

### é—®é¢˜ 3: ä¼šè¯çŠ¶æ€ä¸åŒæ­¥

**é”™è¯¯**: ä¼šè¯çŠ¶æ€ä¸è‰ç¨¿çŠ¶æ€ä¸ä¸€è‡´
**è§£å†³**: ä½¿ç”¨ `confirm_publish` æ–¹æ³•åŒæ­¥çŠ¶æ€

---

## ğŸ”’ å®‰å…¨æ€§

1. **HTML è½¬ä¹‰**: é˜²æ­¢ XSS æ”»å‡»
2. **è¾“å…¥éªŒè¯**: æ‰€æœ‰è¾“å…¥éƒ½ç»è¿‡éªŒè¯
3. **çŠ¶æ€ç®¡ç†**: æ¸…æ™°çš„çŠ¶æ€è½¬æ¢
4. **å†å²è®°å½•**: å®Œæ•´çš„æ“ä½œå®¡è®¡

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯ç”¨åŠŸèƒ½

```python
from common.preview import (
    default_previewer,
    create_draft,
    preview_text
)

# åˆ›å»ºè‰ç¨¿
draft = create_draft(
    title="æ ‡é¢˜",
    content="å†…å®¹",
    tags=["æ ‡ç­¾"],
    image_prompts=["å›¾ç‰‡æç¤ºè¯"]
)

# é¢„è§ˆæ–‡æœ¬
preview = preview_text(draft, format_type="markdown")
print(preview)
```

### ä¸‹ä¸€ä¸ªä»»åŠ¡: Task 3.3 - å‹å¥½é”™è¯¯æç¤º

**ç›®æ ‡**: æå‡é”™è¯¯å¤„ç†ä½“éªŒ

**å†…å®¹**:
- å°†æŠ€æœ¯é”™è¯¯è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯
- æä¾›å…·ä½“çš„è§£å†³å»ºè®®
- æ·»åŠ é”™è¯¯ä»£ç å’Œåˆ†ç±»
- å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯

**é¢„ä¼°æ—¶é—´**: 8 å°æ—¶

**ä¼˜å…ˆçº§**: P1

---

## ğŸ“ˆ æ•´ä½“è¿›åº¦

```
ç¬¬ä¸‰é˜¶æ®µ: ç”¨æˆ·ä½“éªŒæå‡ (67% å®Œæˆ)
â”œâ”€â”€ âœ… Task 3.1: äº¤äº’å¼é…ç½®å‘å¯¼ (å·²å®Œæˆ)
â”œâ”€â”€ âœ… Task 3.2: å†…å®¹é¢„è§ˆåŠŸèƒ½ (å·²å®Œæˆ) â† å½“å‰
â””â”€â”€ â³ Task 3.3: å‹å¥½é”™è¯¯æç¤º (ä¸‹ä¸€ä¸ª)

æ€»ä½“è¿›åº¦: 50% (10/20 ä»»åŠ¡å®Œæˆ)
```

---

## ğŸ’¡ é‡è¦æç¤º

### å¯¹äºç”¨æˆ·

1. **å‘å¸ƒå‰é¢„è§ˆ**: å§‹ç»ˆä½¿ç”¨é¢„è§ˆåŠŸèƒ½æ£€æŸ¥å†…å®¹
2. **åˆ†æ­¥ç¡®è®¤**: ä»”ç»†æ£€æŸ¥æ¯ä¸ªæ­¥éª¤
3. **å›¾ç‰‡é‡æ–°ç”Ÿæˆ**: ä¸æ»¡æ„å¯ä»¥é‡æ–°ç”Ÿæˆ

### å¯¹äºå¼€å‘è€…

1. **æ‰©å±•é¢„è§ˆæ ¼å¼**: æ·»åŠ æ–°çš„æ ¼å¼ç±»å‹
2. **è‡ªå®šä¹‰ç”Ÿæˆå™¨**: å®ç°è‡ªå·±çš„å›¾ç‰‡ç”Ÿæˆå™¨
3. **çŠ¶æ€ç®¡ç†**: ç¡®ä¿çŠ¶æ€æ­£ç¡®è½¬æ¢

---

**ä»»åŠ¡å®Œæˆï¼** å†…å®¹é¢„è§ˆåŠŸèƒ½å·²å®ç°ï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ âœ…
