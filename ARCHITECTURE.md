# 小红书 AI 运营系统 - 架构说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户交互层 (User Interface)                       │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         Claude Code 对话界面                          │  │
│  │                                                                       │  │
│  │  用户输入: "/xhs 发布 春天来了，推荐3个赏花好去处"                   │  │
│  │  AI 输出: "✅ 发布成功！笔记链接: https://..."                       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────┬───────────────────────────────────────┘
                                       │
                                       ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                          意图识别层 (Intent Layer)                          │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                       xhs-operator Skill                             │  │
│  │                                                                       │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │ 触发词识别    │  │ 工作流编排    │  │ MCP 映射     │               │  │
│  │  │              │  │              │  │              │               │  │
│  │  │ /xhs 发布    │→ │ publish 工作流 │→ │ 调用各个 MCP  │               │  │
│  │  │ /xhs 创作    │  │ create 工作流  │  │              │               │  │
│  │  │ /xhs 分析    │  │ analyze 工作流 │  │              │               │  │
│  │  │ /xhs 定时    │  │ schedule 工作流│  │              │               │  │
│  │  │ /xhs 批量    │  │ batch 工作流   │  │              │               │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────┬───────────────────────────────────────┘
                                       │
                                       ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                         工作流协调层 (Orchestration Layer)                   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      integration-mcp                                  │  │
│  │                                                                       │  │
│  │  协调多个 MCP 服务器，执行复杂工作流                                    │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  工作流执行引擎                                                  │ │  │
│  │  │                                                                  │ │  │
│  │  │  步骤1: 调用 LLM 生成内容                                        │ │  │
│  │  │    ↓                                                            │ │  │
│  │  │  步骤2: 调用 stability-mcp 生成配图                              │ │  │
│  │  │    ↓                                                            │ │  │
│  │  │  步骤3: 调用 xiaohongshu-mcp 发布                                │ │  │
│  │  │    ↓                                                            │ │  │
│  │  │  步骤4: 记录结果                                                 │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────┬───────────────────────────────────────┘
                                       │
                                       ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MCP 服务层 (MCP Services Layer)                    │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │xiaohongshu-  │  │ stability-   │  │ tavily-      │  │ scheduler-   │   │
│  │    mcp       │  │    mcp       │  │  remote      │  │    mcp       │   │
│  │              │  │              │  │              │  │              │   │
│  │ • 发布笔记   │  │ • 生成配图   │  │ • 内容搜索   │  │ • 定时任务   │   │
│  │ • 获取数据   │  │ • 3:4 比例   │  │ • AI 优化    │  │ • Cron 调度  │   │
│  │ • 搜索笔记   │  │ • 多种风格   │  │              │  │ • 任务监控   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐                                         │
│  │ analytics-   │  │ integration-  │                                         │
│  │    mcp       │  │    mcp       │                                         │
│  │              │  │ (自身)       │                                         │
│  │ • 数据分析   │  │ • 工作流协调  │                                         │
│  │ • 生成报告   │  │ • 多 MCP 调度│                                         │
│  │ • 优化建议   │  │              │                                         │
│  └──────────────┘  └──────────────┘                                         │
└──────────────────────────────────────┬───────────────────────────────────────┘
                                       │
                                       ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                          外部服务层 (External Services)                      │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ 小红书平台   │  │ Stability AI │  │  Tavily API  │  │  文件系统    │   │
│  │              │  │              │  │              │  │              │   │
│  │ • 笔记发布   │  │ • 图像生成   │  │ • 网络搜索   │  │ • 数据存储   │   │
│  │ • 数据获取   │  │ • AI 模型    │  │ • 内容抓取   │  │ • 配置管理   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 数据流图

### 发布工作流数据流

```
用户输入主题
    │
    ↓
┌─────────────────────────────┐
│  1. 解析输入                 │
│     • 提取主题               │
│     • 识别风格               │
│     • 确定工作流             │
└──────────┬──────────────────┘
           ↓
┌─────────────────────────────┐
│  2. 生成内容                 │
│     • 读取 Prompt 模板       │
│     • 调用 LLM 生成          │
│     • 输出: 标题、正文、标签  │
└──────────┬──────────────────┘
           ↓
┌─────────────────────────────┐
│  3. 生成配图                 │
│     • 构建图像 Prompt        │
│     • 调用 stability-mcp     │
│     • 输出: 图片 URL          │
└──────────┬──────────────────┘
           ↓
┌─────────────────────────────┐
│  4. 发布笔记                 │
│     • 调用 xiaohongshu-mcp   │
│     • 上传图片               │
│     • 发布内容               │
│     • 输出: 笔记链接          │
└──────────┬──────────────────┘
           ↓
┌─────────────────────────────┐
│  5. 返回结果                 │
│     • 展示发布状态           │
│     • 提供笔记链接           │
└─────────────────────────────┘
```

---

## 组件交互图

```
┌─────────────┐
│   用户      │
└──────┬──────┘
       │ 对话
       ↓
┌─────────────┐
│ Claude Code │◄────────┐
└──────┬──────┘         │
       │                │
       │ Skill 调用      │
       ↓                │
┌─────────────┐         │
│ xhs-operator│         │
│   Skill     │         │
└──────┬──────┘         │
       │                │
       │ 工作流执行      │
       ↓                │
┌──────────────────┐    │
│ integration-mcp  │    │
│  (协调器)         │    │
└──────┬───────────┘    │
       │                │
       │ 调用各个 MCP    │
       ├────────────────┼────────────────┬───────────────┐
       ↓                ↓                ↓               ↓
┌──────────┐    ┌──────────┐     ┌──────────┐    ┌──────────┐
│  LLM     │    │stability │     │xiaohongsh│    │scheduler │
│ (内置)   │    │   -mcp   │     │   u-mcp  │    │   -mcp   │
└──────────┘    └──────────┘     └──────────┘    └──────────┘
       │                │                │               │
       └────────────────┴────────────────┴───────────────┘
                        │
                        ↓
                 ┌──────────┐
                 │ 外部 API  │
                 └──────────┘
```

---

## 部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        本地环境 (Your Mac)                        │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Claude Code  │  │ Python 3.9+  │  │  Node.js 18+ │          │
│  │   应用       │  │   环境       │  │   环境       │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│         │                 │                  │                   │
│         └─────────────────┴──────────────────┘                   │
│                           │                                       │
│         ┌─────────────────┴──────────────────┐                   │
│         │     ~/.claude/skills/xhs-operator  │                   │
│         │     ~/.refly/mcp-servers/          │                   │
│         └────────────────────────────────────┘                   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  MCP 服务器 (Python)                     │    │
│  │                                                          │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │    │
│  │  │scheduler │  │analytics │  │integration│              │    │
│  │  │   -mcp   │  │   -mcp   │  │   -mcp   │              │    │
│  │  └──────────┘  └──────────┘  └──────────┘              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  Docker 容器                             │    │
│  │                                                          │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │           xiaohongshu-mcp                        │  │    │
│  │  │     (小红书 API 服务)                             │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP API
                                ↓
┌──────────────────────────────────────────────────────────────────┐
│                        云端服务 (Cloud)                           │
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │小红书 API│  │Stability │  │ Tavily   │  │ 其他 API │        │
│  │          │  │   AI     │  │          │  │          │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└──────────────────────────────────────────────────────────────────┘
```

---

## 模块职责

### 1. xhs-operator Skill
**职责**：
- 意图识别：理解用户输入
- 工作流选择：选择合适的工作流
- 参数提取：提取工作流参数
- 结果展示：格式化输出结果

**输入**：用户自然语言
**输出**：结构化工作流调用

### 2. integration-mcp
**职责**：
- 工作流编排：协调多个步骤
- MCP 调用：调用各个 MCP 服务器
- 数据传递：在步骤间传递数据
- 错误处理：处理执行错误

**输入**：工作流名称和参数
**输出**：执行结果

### 3. xiaohongshu-mcp
**职责**：
- 小红书 API 封装
- 笔记发布
- 数据获取
- 账号管理

**输入**：发布内容
**输出**：笔记链接/数据

### 4. stability-mcp
**职责**：
- 图像生成 API 调用
- Prompt 优化
- 图像质量检查
- 格式转换

**输入**：文本 Prompt
**输出**：图像 URL

### 5. scheduler-mcp
**职责**：
- 任务调度
- Cron 解析
- 任务持久化
- 状态监控

**输入**：Cron 表达式和工作流
**输出**：任务 ID

### 6. analytics-mcp
**职责**：
- 数据分析
- 报告生成
- 趋势识别
- 建议生成

**输入**：笔记数据
**输出**：分析报告

---

## 安全架构

```
┌─────────────────────────────────────────────────────────────┐
│                       安全层                                  │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  敏感词过滤  │  │  风控规则    │  │  API Key 管理 │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
                           │
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据安全                                 │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 本地存储     │  │ 加密传输     │  │ 访问控制     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 扩展架构

系统支持以下扩展：

### 1. 新增内容风格
- 在 `PROMPTS/content_generation.md` 添加新风格
- 更新 `SKILL.md` 中的触发词

### 2. 新增内容模板
- 在 `CONFIG/templates.json` 添加新模板
- 自动在发布时可选择

### 3. 新增工作流
- 在 `integration-mcp` 中定义新工作流
- 在 `SKILL.md` 中注册触发词

### 4. 新增 MCP 服务器
- 实现标准 MCP 协议
- 在 `integration-mcp` 中注册
- 更新配置文件

---

## 监控架构

```
┌─────────────────────────────────────────────────────────────┐
│                        监控层                                 │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  任务日志    │  │  性能指标    │  │  错误追踪    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
                           │
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                      告警层                                   │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  失败告警    │  │  异常检测    │  │  自动恢复    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

**文档版本**: 1.0.0
**最后更新**: 2025-02-06
